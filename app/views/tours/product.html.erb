<% content_for :javascript_includes do %>
    <%= javascript_include_tag "calendar-app.js", defer: true %>
    <script type="text/javascript">
        document.addEventListener("turbolinks:load", function(){
            if(document.getElementById("calendar-app")) {
                var calendar = new CalendarApp(new Date(), [
                    <% @availability_json["sessions"].each do |s| %>
                    {
                        name: "<%= s["productCode"] %>",
                        startTime: "<%= s["startTime"].to_datetime %>",
                        endTime: "<%= s["endTime"].to_datetime %>",
                        day: "<%= s["startTime"].to_datetime %>"
                    },
                    <% end %>
                ]);
            }
        });
    </script>
<% end %>
<%= render 'layouts/navbar' %>
<div class="cover">
  <div class="img-holder">
    <%= image_tag(@product_json["product"]["images"][0]["largeSizeUrl"], :alt => "Truppie", :class => "img-fluid img-fit symbol-big") %>
    <div class="ribbon base" style="text-align: right">
      <span><%= raw final_price(@product_json["product"]["advertisedPrice"]) %></span>
      <%= link_to t('tours_view_show_link_one'), '#', class: 'btn btn-primary btn-sm btn-block' %>
    </div>
  </div>

  <div class="container">
    <div class="row divider-default">
      <div class="col-xs-12">
        <%= render 'layouts/flash' %>
        <div class="pull-xs-right tour-container">
          <h4 class="tour-title spaced-smallest pull-xs-right"><strong><%= @product_json["product"]["name"] %></strong></h4>

          <div class="pull-xs-right" style="clear:both">
            <small  style="display:block; text-align: right"><%= t('tours_view_show_small_one') %><strong class="text-danger"><%= @tour.try(:category).try(:name) || t('tours_view_show_strong_one') %></strong></small>

            <div class="spaced-smallest pull-xs-right" style="display:block; text-align: right">
              <small>tags:</small>
              <% @tour.tags.each do |tag| %>
                  <span class="tags label label-info"><%= tag.name %></span>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-xs-6">
        <div class="calendar" id="calendar-app">
          <div class="calendar--day-view" id="day-view">
            <span class="day-view-exit" id="day-view-exit">&times;</span>
            <span class="day-view-date" id="day-view-date">MAY 29 2016</span>
            <div class="day-view-content">
              <div class="day-highlight">
                You <span class="day-events" id="day-events">had no events for today</span>. &nbsp; <span tabindex="0" onkeyup="if(event.keyCode != 13) return; this.click();" class="day-events-link" id="add-event" data-date>Add a new event?</span>
              </div>
              <div class="day-add-event" id="add-day-event-box" data-active="false">
                <div class="row">
                  <div class="half">
                    <label class="add-event-label">
                      Name of event
                      <input type="text" class="add-event-edit add-event-edit--long" placeholder="New event" id="input-add-event-name">
                    </label>
                  </div>
                  <div class="qtr">
                    <label class="add-event-label">
                      Start Time
                      <input type="text" class="add-event-edit" placeholder="8:15" id="input-add-event-start-time" data-options="1,2,3,4,5,6,7,8,9,10,11,12" data-format="datetime">
                      <input type="text" class="add-event-edit" placeholder="am" id="input-add-event-start-ampm" data-options="a,p,am,pm">
                    </label>
                  </div>
                  <div class="qtr">
                    <label class="add-event-label">
                      End Time
                      <input type="text" class="add-event-edit" placeholder="9" id="input-add-event-end-time" data-options="1,2,3,4,5,6,7,8,9,10,11,12" data-format="datetime">
                      <input type="text" class="add-event-edit" placeholder="am" id="input-add-event-end-ampm" data-options="a,p,am,pm">
                    </label>
                  </div>
                  <div class="half">
                    <a onkeyup="if(event.keyCode != 13) return; this.click();" tabindex="0" id="add-event-save" class="event-btn--save event-btn">save</a>
                    <a tabindex="0" id="add-event-cancel" class="event-btn--cancel event-btn">cancel</a>
                  </div>
                </div>

              </div>
              <div id="day-events-list" class="day-events-list">
                <ul class="day-event-list-ul"><li class="event-dates"><div class="event-dates"><span class="start-time">8:15 AM</span> <small>through</small> <span class="end-time">9:00 AM</span><span class="event-name">fadfaf</span><span class="event-delete" data-idx="2">delete</span></div></li></ul>
              </div>
              <div class="day-inspiration-quote" id="inspirational-quote">
                Every child is an artist.  The problem is how to remain an artist once he grows up. –Pablo Picasso
              </div>
            </div>
          </div>
          <div class="calendar--view" id="calendar-view">
            <div class="cview__month">
              <span class="cview__month-last" id="calendar-month-last">Apr</span>
              <span class="cview__month-current" id="calendar-month">May</span>
              <span class="cview__month-next" id="calendar-month-next">Jun</span>
            </div>
            <div class="cview__header">Sun</div>
            <div class="cview__header">Mon</div>
            <div class="cview__header">Tue</div>
            <div class="cview__header">Wed</div>
            <div class="cview__header">Thu</div>
            <div class="cview__header">Fri</div>
            <div class="cview__header">Sat</div>
            <div class="calendar--view" id="dates">
            </div>
          </div>
          <div class="footer">
            <span><span id="footer-date" class="footer__link">Today is May 30</span></span>
          </div>
        </div>
      </div>
      <div class="col-xs-6">
        sidebar
      </div>
    </div>
    <div class="row">
      <div class="col-xs-12">
        <h4><strong><%= t('tours_view_show_strong_four') %></strong></h4>
        <code><%= @availability_json.inspect %></code>
        <p><%= raw @product_json["product"]["description"] %></p>
      </div>
    </div>
    <div class="row">
      <div class="col-xs-12 col-md-6">
        <%= render partial: 'layouts/organizer_card', locals: {organizer: @tour.organizer} %>
      </div>

      <div class="col-xs-12 col-md-6">
        <div class="card">
          <div class="card-header">
            <h5 class="spaced-smallest"><i class="fa fa-info-circle"></i> <strong><%= t('tours_view_show_strong_three') %></strong></h5>
          </div>

          <div class="card-block">
            <ul class="list-unstyled tour-info">
              <li>
                <% if not @tour.soldout? or not @tour.available.empty? %>
                    <i class="fa fa-ticket"></i>
                    <strong><%= @tour.available %></strong> <%= t('tours_view_show_li_one') %>
                <% else %>
                    <i class="fa fa-ticket"></i>
                    <%= t('tours_view_show_li_two') %>
                <% end %>
              </li>

              <% if @tour.try(:minimum) %>
                  <li><i class="fa fa-child"></i>  <strong><%= @tour.minimum %></strong> <%= t('tours_view_show_li_three') %></li>
              <% end %>

              <!--<li><i class="fa fa-calendar"></i>  Duração total de <strong><%= @tour.duration %></strong></li> -->
              <li><i class="fa fa-calendar"></i> <%= @tour.how_long %> </li>
              <li><i class="fa fa-clock-o"></i> <%= t('tours_view_show_li_four') %> <%= l(@tour.formatted_start, format: '%d de %B / %Y') %> às <%= l(@tour.formatted_start, format: '%Hh%M') %> </li>
              <li><i class="fa fa-history"></i> <%= t('tours_view_show_li_finish') %> <%= l(@tour.formatted_end, format: '%d de %B / %Y') %> às <%= l(@tour.formatted_end, format: '%Hh%M') %> </li>

              <% if @tour.try(:difficulty) %>
                  <li><i class="fa fa-heartbeat"></i> <%= t('tours_view_show_li_five') %> <strong><%= @tour.level %></strong> </li>
              <% end %>

              <% if @tour.try(:address) and !@tour.address.empty? %>
                  <li><i class="fa fa-map-marker"></i>  <strong> <%= @tour.address %></strong></li>
              <% end %>

              <% if @tour.languages.present? %>
                  <li>
                    <i class="fa fa-globe"></i>
                    <%= t('tours_view_show_li_six') %>
                    <strong><%= @tour.languages.map { |m| m.name }.join(', ') %></strong>
                  </li>
              <% end %>

              <% if @tour.try(:link) %>
                  <% if !@tour.link.empty? %>
                      <li><a href="<%= @tour.link %>"><i class="fa fa-facebook-square"></i> <%= t('tours_view_show_li_seven') %></a></li>
                  <% end %>
              <% end %>
            </ul>
          </div>

          <div class="card-footer">
            <!-- <div class="row">
                  <div class="col-xs-12">
                    <div class="text-xs-center">
                      <p><small><span class="label label-default" style="background-color: #BBB;"> reserve agora e concorra a outro passeio do <%= @tour.organizer.name %>!</span></small></p>
                    </div>
                  </div>
            </div> -->
            <% if @tour.past? %>
                <%= link_to t('tours_view_show_link_interest'), show_interest_tour_path, class: 'btn btn-primary btn-lg btn-block', remote: user_signed_in? %>
            <% else %>
                <%= link_to t('tours_view_show_link_three'), confirm_tour_path, class: 'btn btn-primary btn-lg btn-block' %>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <% if @product_json["product"]["images"].any? %>
        <div class="row">
          <div class="col-xs-12">
            <h4 class="spaced-top">
              <%= t('tours_view_show_h4') %>
            </h4>
          </div>

          <div class="cols-xs-12">
            <div class="gallery">
              <% @product_json["product"]["images"].each do |i| %>
                  <div class="gallery-image">
                    <%= image_tag i["largeSizeUrl"], :alt => "Truppie", class: "img-fluid" %>
                  </div>
              <% end %>
            </div>
          </div>
        </div>
    <% end %>

    <% unless @tour.past? %>

        <% if @tour.packages.any? and !@tour.value %>
            <div class="row">
              <div class="col-xs-12">
                <h3 class="spaced-default">
                  <a name="packages"><%= t('tours_view_show_a_two') %></a>
                </h3>
              </div>
            </div>
            <% @tour.packages.each_slice(2) do |part| %>
                <div class="row text-xs-center">
                  <% part.each do |p| %>
                      <!-- item -->
                      <div class="col-md-6">
                        <div class="card panel-pricing">
                          <div class="card-header card-info" style="color: white;">
                            <h3><%= p.name %></h3>
                          </div>
                          <div>
                            <div class="panel-body text-xs-center">
                              <p><strong><%= raw p.price %></strong></p>
                            </div>
                            <div class="card-body text-xs-center" style="margin-top: 10px; margin-bottom: 10px;">
                              <% if !p.description.nil? and !p.description.empty? %>
                                  <p><%= raw p.description %></p>
                              <% end %>
                            </div>
                            <% if p.included.any? %>
                                <ul class="list-group text-xs-center" style="overflow-y: scroll; height: 150px">
                                  <% p.included.each do |i| %>
                                      <li class="list-group-item"><i class="fa fa-check"></i> <%= i %></li>
                                  <% end %>
                                </ul>
                            <% end %>
                          </div>
                          <div class="card-footer">
                            <%= link_to t("tours_view_show_link_four",name: p.name), confirm_tour_path(@tour.id, p.name), class: 'btn btn-lg btn-block btn-primary' %>
                          </div>
                        </div>
                      </div>
                      <!-- /item -->
                  <% end %>
                </div>
            <% end %>
        <% end %>
    <% end %>
    <div class="row">
      <% if !@tour.take.empty? %>
          <div class="col-xs-12 col-md-6">
            <h4 class="spaced-smallest"><strong><%= t('tours_view_show_strong_five') %></strong></h4>
            <ul class="list-group spaced-down">
              <% @tour.take.each do |t| %>
                  <li class="list-group-item"><i class="fa fa-hand-o-right"></i> <%= t %></li>
              <% end %>
            </ul>
          </div>
      <% end %>

      <% if !@tour.goodtoknow.empty? %>
          <div class="col-xs-12 col-md-6">
            <h4 class="spaced-smallest"><strong><%= t('tours_view_show_strong_six') %></strong></h4>
            <ul class="list-group spaced-down">
              <% @tour.goodtoknow.each do |t| %>
                  <li class="list-group-item"><i class="fa fa-thumbs-o-up"></i> <%= t %></li>
              <% end %>
            </ul>
          </div>
      <% end %>
    </div>

    <div class="row">
      <% if !@tour.included.empty? %>
          <div class="col-xs-12 col-md-6">
            <h4 class="spaced-smallest"><strong><%= t('tours_view_show_strong_seven') %></strong></h4>
            <ul class="list-group spaced-down">
              <% @tour.included.each do |t| %>
                  <li class="list-group-item"><i class="fa fa-check-circle-o"></i> <%= t %></li>
              <% end %>
            </ul>
          </div>
      <% end %>

      <% if !@tour.nonincluded.empty? %>
          <div class="col-xs-12 col-md-6">
            <h4 class="spaced-smallest"><strong><%= t('tours_view_show_strong_eight') %></strong></h4>
            <ul class="list-group spaced-down">
              <% @tour.nonincluded.each do |t| %>
                  <li class="list-group-item"><i class="fa fa-ban"></i> <%= t %></li>
              <% end %>
            </ul>
          </div>
      <% end %>
    </div>

    <% if !@tour.meetingpoint.nil? %>
        <div class="row">
          <div class="col-xs-12">
            <h4 class="spaced-smallest"><strong><%= t('tours_view_show_strong_nine') %></strong></h4>
            <p><%= @tour.meetingpoint %></p>
          </div>
        </div>
    <% end %>

    <div class="row">
      <div class="col-xs-12">
        <%= render partial: 'layouts/confirmeds_full', locals: {tour: @tour} %>
      </div>
    </div>
  </div><!-- end container -->

  <% @tour.wheres.each do |w| %>
      <div class="show-map" id="map"></div>
      <script type="text/javascript">
          window.addEventListener("turbolinks:load", function () {
              function initMap() {
                  var map_element = document.getElementById('map');

                  if(!map_element){
                      return;
                  }

                  var map = new google.maps.Map(map_element, {
                      zoom: 8,
                      center: {lat: 40.72, lng: -73.96}
                  });

                  var geocoder = new google.maps.Geocoder;
                  var infowindow = new google.maps.InfoWindow;
                  var placeId = "<%= w.place_id %>";

                  <% if w.place_id.blank? %>
                  var place_object = {location: {lat: <%= w.try(:lat) || '40.72' %>, lng: <%= w.try(:long) || '-73.96' %>}};
                  <% else %>
                  var place_object = {placeId: placeId };
                  <% end %>

                  geocoder.geocode(place_object, function (results, status) {
                      if (status === 'OK') {
                          if (results[0]) {
                              map.setZoom(11);
                              map.setCenter(results[0].geometry.location);

                              var marker = new google.maps.Marker({
                                  map: map,
                                  position: results[0].geometry.location
                              });

                              infowindow.setContent(results[0].formatted_address);
                              infowindow.open(map, marker);
                          } else {
                              window.alert('No results found');
                          }
                      } else {
                          window.alert('Geocoder failed due to: ' + status);
                      }
                  });
              }

              initMap();
          });
      </script>
  <% end %>

  <% @tour.attractions.each do |attraction| %>
      <div class="row">
        <div class="col-xs-12">
          <h4 class="spaced-smallest"><strong><%= t('tours_view_show_strong_ten') %></strong></h4>
        </div>
      </div>

      <div class="col-sm-6">
        <div class="card">
          <div class="card-block">
            <h4 class="card-title"><%= attraction.name %></h4>
          </div>

          <img src="<%= attraction.photo %>" alt="Card image" class="img-fluid">

          <div class="card-block">
            <p class="card-text"><%= attraction.text %></p>
          </div>
        </div>
      </div>
  <% end %>
</div>
